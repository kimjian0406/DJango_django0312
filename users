from django.views.generic import CreateView
from django.urls import reverse_lazy
from .forms import SignupForm
from django.core.mail import send_mail
from django.conf import settings
from django.core.signing import TimestampSigner
from .utils.email import send_verification_email

class SignupView(CreateView):
    model = CustomUser
    form_class = SignupForm
    template_name = 'registration/signup.html'
    success_url = reverse_lazy('users:signup_done')

    def form_valid(self, form):
        # 회원가입 시 사용자 데이터 저장
        user = form.save(commit=False)
        user.is_active = False  # 이메일 인증 전에는 비활성화 상태
        user.save()

        # 이메일 인증을 위한 링크 전송
        signer = TimestampSigner()
        signed_data = signer.sign(user.email)
        verification_url = self.request.build_absolute_uri(
            reverse_lazy('users:verify', kwargs={'signed_data': signed_data})
        )
        send_verification_email(user.email, verification_url)

        return super().form_valid(form)

